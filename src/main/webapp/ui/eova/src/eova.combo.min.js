(function(b){function g(a,c){if(a.options.multiple){for(var d=a.getValues(),b=0;b<d.length;b++)if(d[b]==c)return;d.push(c);a.setValues(d)}else a.setValues([c])}var l=b.fn.eovatext.TextBox;COMBOBOX="combobox";b.fn.eovacombo=function(a){var c=[];this.each(function(){var d=b.data(this,COMBOBOX);d?b.extend(d.options,a):(d=new e(this,a),d.render(),d.reload(),d.bindEvents());b.data(this,COMBOBOX,d);c.push(d)});return 1==c.length?c[0]:c};var e=b.fn.eovacombo.ComboBox=function(a,c){l.apply(this,arguments);this.defaults={btnTitle:"\u70b9\u51fb\u9009\u62e9\u5185\u5bb9",btnIcon:"",isReadonly:!0,multiple:!1,separator:",",editable:!0,valueField:"id",textField:"cn",onChange:function(a,c){}};this.options=b.extend({},this.options,this.defaults,b.getHtmlOptions(this),c);console.log(this.options)};b.extendPrototype(e,l);e.prototype.render=function(){var a=b("\x3cinput type\x3d'hidden' /\x3e").appendTo(this.$dom),c=b("\x3cinput type\x3d'text' /\x3e").appendTo(this.$dom),d=b("\x3ci class\x3d'ei'\x3e\x3c/i\x3e").appendTo(this.$dom),f=b("\x3cdiv class\x3d'eova-combo-panel'\x3e\x3c/div\x3e").appendTo("body");d.attr("title",this.options.btnTitle);f.css("cursor","pointer");this.name&&a.attr("name",this.name);this.value&&a.attr("value",this.value);this.options.placeholder&&c.attr("placeholder",this.options.placeholder);this.options.required&&c.attr("required","required");this.options.disable&&this.$dom.mask();this.options.isReadonly&&(c.attr("readonly","readonly"),c.css("cursor","pointer"),c.attr("title",this.options.btnTitle));this.$valuebox=a;this.$textbox=c;this.$btn=d;this.$panel=f;this.setWidth(this.options.width)};e.prototype.bindEvents=function(){var a=this.$textbox,c=this.$panel;c.unbind(".eovacombo");this.$dom.click(function(d){b(".eova-combo-panel").is(":visible")&&b(".eova-combo-panel").hide();var f=a.offset();c.css({position:"absolute",left:f.left-1,top:f.top+21,height:200,overflow:"auto",width:b(this).width()});c.show();console.log(".eova-combo click");d.stopPropagation()});c.bind("mousedown.eovacombo",function(a){return!1});b(document).unbind(".eovacombo").bind("mousedown.eovacombo",function(a){b(".eova-combo-panel").is(":visible")&&b(".eova-combo-panel").hide()})};e.prototype.destroy=function(){this.$dom.remove();this.$panel.remove()};e.prototype.reload=function(){var a=this,c=this.options,d=c.url;d||(d=this.$dom.attr("url"));d?b.ajax({type:"get",async:!0,url:d,dataType:"json",success:function(d){a.$panel.empty();b.each(d,function(d,f){var e=b.clipStr(f[c.textField],11);b('\x3cdiv value\x3d"'+f[c.valueField]+'"\x3e'+e+"\x3c/div\x3e").appendTo(a.$panel)});a.$panel.children("div").unbind(".eovacombo").bind("mousedown.eovacombo",function(d){var f=b(this),e=f.attr("value");if(c.multiple)if(f.hasClass("eova-combo-selected"))for(var f=a.getValues(),k=0;k<f.length;k++){if(f[k]==e){f.splice(k,1);a.setValues(f);break}}else g(a,e);else g(a,e),a.$panel.hide();console.log("reload combo panel div click");d.stopPropagation()});a.getValue()&&(c.multiple?a.setValues(a.getValues()):a.setValue(a.getValue()));b.data(this,COMBOBOX,a)},error:function(){alert("\u4e0b\u62c9\u6846\u52a0\u8f7d\u6570\u636e\u5931\u8d25,URL\x3d"+d)}}):b("\x3cdiv\x3e\u6570\u636e\u672a\u52a0\u8f7d\x3c/div\x3e").appendTo(a.$panel)};e.prototype.getValue=function(){return this.$valuebox.val()};e.prototype.getValues=function(){var a=this.$valuebox.val();return""==a?[]:a.split(this.options.separator)};e.prototype.setValue=function(a){this.setValues([a])};e.prototype.setValues=function(a){this.$panel.children().removeClass("eova-combo-selected");for(var c=[],d=[],b=0;b<a.length;b++){var e=a[b],h=this.$panel.children("div[value\x3d'"+e+"']");c.push(e);d.push(h.text());h.addClass("eova-combo-selected")}b=this.getValues();this.$valuebox.val(c.join(this.options.separator));this.$textbox.val(d.join(this.options.separator));c=this.options;c.multiple?a.length!=b.length&&c.onChange.call(this.$dom,b,a):a[0]!=b[0]&&c.onChange.call(this.$dom,b[0],a[0])};e.prototype.getText=function(){return this.$textbox.val()};e.prototype.getTexts=function(){var a=this.$textbox.val();return""==a?[]:a.split(this.options.separator)};e.prototype.setText=function(a){return this.setTexts([a])};e.prototype.setTexts=function(a){this.$panel.children().removeClass("eova-combo-selected");for(var b=[],d=[],e=0;e<a.length;e++){var g=a[e],h=this.$panel.children("div:contains('"+g+"')");b.push(h.attr("value"));d.push(g);h.addClass("eova-combo-selected")}this.$valuebox.val(b.join(this.options.separator));this.$textbox.val(d.join(this.options.separator))}})(jQuery);